<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Meals List</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .meal-table {
            margin-top: 20px;
        }
        .meal-table th, .meal-table td {
            text-align: center;
        }
        .meal-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .meal-info span {
            margin-bottom: 5px;
        }
        .meal-time {
            font-weight: bold;
        }

        /* Custom styles for the highlighted code */
        .highlight-code {
            font-size: 2rem; /* Larger font size */
            font-weight: bold;
            color: #28a745; /* Green color */
            background-color: #f8f9fa; /* Light background */
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Back Button -->
    <div class="mt-4 mb-3">
        <a href="javascript:history.back()" class="btn btn-secondary">‚Üê Back</a>
    </div>

    <!-- Title -->
    <div class="mb-4">
        <h1 class="text-center">Meals at the Restaurant: <span th:text="${restaurant.name}"></span></h1>
    </div>

    <!-- Empty State -->
    <div th:if="${(mealsByDateAndType ?: {}).isEmpty()}">
        <div class="alert alert-warning text-center" role="alert">
            No meals available for this restaurant on the selected dates.
        </div>
    </div>

    <!-- Meal Table -->
    <div class="meal-table">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Lunch</th>
                <th>Dinner</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="mealByDate : ${mealsByDateAndType}">
                <!-- Date and Weekday -->
                <td th:text="${#temporals.format(mealByDate.key, 'EEEE')} + ' - ' + ${#temporals.format(mealByDate.key, 'yyyy-MM-dd')}" class="align-middle"></td>

                <!-- Lunch -->
                <td class="align-middle">
                    <div class="meal-info" th:if="${mealByDate.value['lunch'] != null}">
                        <span th:text="${mealByDate.value['lunch'].get(0).name}"></span>
                        <span class="meal-time">12:00 - 14:30</span>
                        <span th:text="'Reservation Limit: ' + ${mealByDate.value['lunch'].get(0).reservationLimit}"></span>
                        <button class="btn btn-success mt-2" onclick="confirmReservation(this)" th:attr="data-mealid=${mealByDate.value['lunch'].get(0).id}">
                            Reserve
                        </button>
                    </div>
                    <div th:if="${mealByDate.value['lunch'] == null}">
                        No lunch available
                    </div>
                </td>

                <!-- Dinner -->
                <td class="align-middle">
                    <div class="meal-info" th:if="${mealByDate.value['dinner'] != null}">
                        <span th:text="${mealByDate.value['dinner'].get(0).name}"></span>
                        <span class="meal-time">19:00 - 22:00</span>
                        <span th:text="'Reservation Limit: ' + ${mealByDate.value['dinner'].get(0).reservationLimit}"></span>
                        <button class="btn btn-success mt-2" onclick="confirmReservation(this)" th:attr="data-mealid=${mealByDate.value['dinner'].get(0).id}">
                            Reserve
                        </button>
                    </div>
                    <div th:if="${mealByDate.value['dinner'] == null}">
                        No dinner available
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Reservation Confirmation Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Reservation Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <!-- Highlight the reservation code here -->
                <div id="highlightCode" class="highlight-code" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    function confirmReservation(button) {
        const mealId = button.getAttribute("data-mealid");

        fetch(`/api/v1/reservation/meal/${mealId}`, {
            method: "POST"
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Reservation failed.");
                }
                return res.json();
            })
            .then(data => {
                if (data && data.code) {
                    // Show modal with confirmation message
                    const modalMessage = `Reservation confirmed!`;
                    document.getElementById('modalMessage').innerText = modalMessage;
                    document.getElementById('highlightCode').innerText = `Your code is: ${data.code}`;
                    document.getElementById('highlightCode').style.display = "block"; // Display the code
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('reservationModal'));
                    modal.show();
                } else {
                    // Show modal with failure message
                    const modalMessage = "Reservation could not be completed.";
                    document.getElementById('modalMessage').innerText = modalMessage;
                    document.getElementById('highlightCode').style.display = "none"; // Hide the code
                    const modal = new bootstrap.Modal(document.getElementById('reservationModal'));
                    modal.show();
                }
            })
            .catch(() => {
                // Show modal with error message
                const modalMessage = "Reservation failed. It might be full, expired, or invalid.";
                document.getElementById('modalMessage').innerText = modalMessage;
                document.getElementById('highlightCode').style.display = "none"; // Hide the code
                const modal = new bootstrap.Modal(document.getElementById('reservationModal'));
                modal.show();
            });
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
